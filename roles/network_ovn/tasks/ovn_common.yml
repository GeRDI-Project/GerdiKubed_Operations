- name: Add unstable for newer ovn-version
  apt_repository:
    repo: deb http://debian.mirror.lrz.de/debian unstable main
    state: present

- name: Install package pinning for newer ovn-version
  copy:
    src: ovnovs.pref
    dest: /etc/apt/preferences.d/ovnovs.pref

- name: Install ovn dependencies
  package:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
    - git
    - python-pip
    - virtualenv
    - openvswitch-switch

- name: Install ovn controller systemd unit file
  template:
    src: ovn-controller.service.j2
    dest: /etc/systemd/system/ovn-controller.service

- name: Reload systemd daemon and start ovn controller
  systemd:
    state: started
    name: ovn-controller
    enabled: yes
    daemon-reload: yes

- name: Set db entries on both masters and nodes
  shell: ovs-vsctl set Open_vSwitch . external_ids:{{item}}
  with_items:
    - ovn-remote="tcp:{{ K8S_MASTER_IP }}:6642"
    - ovn-nb="tcp:{{ K8S_MASTER_IP }}:6641"
    - ovn-encap-ip="{{ iface1.ipv4 }}"
    - ovn-encap-type="{{ OVN_ENCAP_TYPE }}"

# TODO: version should sometime be specified to guarantee that it works
- name: Pull k8s ovn integration scripts
  git:
    repo: 'https://github.com/openvswitch/ovn-kubernetes.git'
    dest: "{{ OVN_K8S_DIR }}"

- name: Update pip
  pip:
    name: pip
    state: latest

- name: Install python requirements for k8s ovn integration scripts
  pip:
    requirements: "{{ OVN_K8S_DIR }}/requirements.txt"

- name: Install k8s ovn integration scripts
  shell: "pip install ."
  args:
    chdir: "{{ OVN_K8S_DIR }}"
