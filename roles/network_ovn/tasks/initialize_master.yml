- name: install ovs and ovn master packages
  package:
    name={{ item }}
    state=present
  with_items:
    - ovn-central

- name: Set the k8s api server address in the Open vSwitch database
  shell: ovs-vsctl set Open_vSwitch . external_ids:k8s-api-server="127.0.0.1:8080"

- name: Actually initialize master
  shell: |
    ovn-k8s-overlay master-init \
      --cluster-ip-subnet={{K8S_CLUSTER_IP_SUBNET}} \
      --master-switch-subnet={{ OVN_MASTER_SUBNET_PRE }}.{{ hostname_suffix }}.0/24 \
      --node-name={{ hostname.stdout }}

- name: Check if watcher already runs
  stat:
    path: /var/run/openvswitch/ovn-k8s-watcher.pid
  register: checkWatcher

- name: Run Watcher on master
  shell: "ovn-k8s-watcher --overlay --pidfile --log-file -vfile:info -vconsole:emer --detach"
  when: checkWatcher.stat.exists == False
