---
# Common tasks on every host
- name: Install requirements for adding new deb-repo packages & interactive ansible
  apt:
      pkg: "{{ item }}"
      state: latest
  with_items:
      - apt-transport-https
      - ca-certificates
      - python3-dbus
      - python-openssl
      - iproute2

# TODO Take care of it in image
- name: Turn swapoff
  shell: swapoff -a

- name: Create k8s directories
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
  with_items:
    - { path: "{{ K8S_BASE_DIR    }}", mode: '0755' }
    - { path: "{{ K8S_CERT_FILES_DIR  }}", mode: '0755' }
    - { path: "{{ K8S_AUTH_FILES_DIR  }}", mode: '0755' }
    - { path: "{{ K8S_KEY_FILES_DIR  }}", mode: '0700' }
    - { path: "/etc/kubernetes/manifests", mode: '0755' }

  #- name: get variables
  #debug: var=hostvars[inventory_hostname]

- name: Install certs
  copy:
    src:  "{{ CONTROL_CERT_DIR }}/ca.crt.pem"
    dest: "{{ K8S_CERT_FILES_DIR }}/ca.crt.pem"

- name: set hostname for master
  hostname:
    name: "{{ K8S_CLUSTER_NAME}}-mstr-{{hostname_suffix}}"
  when: inventory_hostname in groups['kubernetes-masters']

- name: set hostname for node
  hostname:
    name: "{{ K8S_CLUSTER_NAME}}-nd-{{hostname_suffix}}"
  when: inventory_hostname in groups['kubernetes-nodes']
