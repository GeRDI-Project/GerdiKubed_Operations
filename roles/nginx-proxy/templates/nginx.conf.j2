server {
  listen  80;
  listen 443 ssl;

  proxy_connect_timeout       600;
  proxy_send_timeout          600;
  proxy_read_timeout          600;
  send_timeout                600;

  ssl on;
  ssl_certificate /etc/ssl/{{ K8S_CLUSTER_NAME }}.ext.{{ K8S_DOMAIN_NAMESPACE }}.crt;
  ssl_certificate_key /etc/ssl/{{ K8S_CLUSTER_NAME }}.ext.{{ K8S_DOMAIN_NAMESPACE }}.key;

  #TODO: We need to streamline www.gerdi.org alongside SAI-682 (e.g. www.staging.gerdi.org)
  server_name ~^{{ K8S_CLUSTER_NAME }}\..*ext.{{ K8S_DOMAIN_NAMESPACE }} www.gerdi.org;

  access_log /var/log/nginx/nginx.vhost.access.log;
  error_log /var/log/nginx/nginx.vhost.error.log;

  location /api/search {
    add_header "Access-Control-Allow-Origin" "*";
    proxy_pass http://10.222.21.10:9200/gerdi/_search;
  }

  location /api/get {
    add_header "Access-Control-Allow-Origin" "*";
    proxy_pass http://10.222.21.10:9200/gerdi/_all;
    limit_except GET {
      deny all;
    }
  }

  # Frontend for presentation purposes
  location / {
    proxy_pass http://10.222.21.09
  }

  # Protect index
  location /api/index {
    proxy_pass http://10.222.21.10:9200/gerdi/metadata;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

  location /harvest/arcgis {
    proxy_pass http://10.222.21.11:8080/arcgis/harvest;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

  location /harvest/faostat {
    proxy_pass http://10.222.21.12:8080/faostat/harvest;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

  location /harvest/pangaea {
    proxy_pass http://10.222.21.13:8080/oaipmh/harvest;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

  location /harvest/oceantea {
    proxy_pass http://10.222.21.14:8080/oaipmh/harvest;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

}
