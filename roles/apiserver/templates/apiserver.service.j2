[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target
After=etcd.service

# TODO Sync with json-template
# TODO review Admission control
# TODO review allow-privileged=true (needed by ntd)
# TODO review logging settings (tostderr -> journalctl and level)
[Service]
ExecStart=/usr/bin/apiserver \
      --allow-privileged=true \
      --anonymous-auth=false \
      --bind-address={{ MASTER_IP }} \
      --client-ca-file={{ CERT_FILES_DIR }}/ca.crt.pem \
      --etcd-cafile={{ CERT_FILES_DIR }}/ca.crt.pem \
      --etcd-certfile={{ CERT_FILES_DIR }}/etcd-client.crt.pem \
      --etcd-keyfile={{ KEY_FILES_DIR }}/etcd-client.key \
      --etcd-servers=https://{{ MASTER_IP }}:2379 \
      --kubelet-certificate-authority={{ CERT_FILES_DIR }}/ca.crt.pem \
      --kubelet-client-certificate={{ CERT_FILES_DIR }}/kubelet-client.crt.pem \
      --kubelet-client-key={{ KEY_FILES_DIR }}/kubelet-client.key \
      --log-dir=/var/log/ \
      --requestheader-client-ca-file={{ CERT_FILES_DIR }}/ca.crt.pem \
      --service-cluster-ip-range={{ CLUSTER_IP_SUBNET }} \
      --tls-ca-file={{ CERT_FILES_DIR }}/ca.crt.pem \
      --tls-cert-file={{ CERT_FILES_DIR }}/apiserver.crt.pem \
      --tls-private-key-file={{ KEY_FILES_DIR }}/apiserver.key \
      --token-auth-file={{ AUTH_FILES_DIR }}/known_tokens.csv \
      --{{ K8S_GLOBAL_LOG_LEVEL }} \

Restart=on-failure
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
